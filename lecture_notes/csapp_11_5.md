# CSAPP 11.5 웹서버


## 1. 웹 기초
- 웹 클라이언트와 서버는 `HTTP`라고 하는 텍스트 기반 응용수준 프로토콜을 사용해 상호 연동한다.

- **HTTP의 수행 절차**
    - 웹 클라이언트는 서버로의 인터넷 연결을 오픈하고 컨텐츠를 요청한다.
    - 서버는 콘텐츠로 응답하고, 그 후에 연결을 닫아준다.
    - 브라우저는 컨텐츠를 읽고 이것을 스크린에 렌더링한다.

- **FTP 와의 차이**
    - 웹 컨텐츠가 HTML이라는 언어로 작성될 수 있다는 것이다. 
    - HTML 프로그램(페이지)은 명령들(태그)을 포함하고 있어서 브라우저에게 어떻게 렌더링할지를 알려준다.

## 2. 웹 콘텐츠
- 웹 클라이언트와 서버에게 콘텐츠는 연관된 `MIME(Multipurpose Internet Mail Extensions)` 타입을 가진 바이트의 배열이다.
- 웹 서버는 두 가지 방식으로 클라이언트에게 콘텐츠를 제공한다.
    - (1) **정적 콘텐츠** : 디스크 파일을 가져와서 그 내용을 클라이언트에게 보낸다. 디스크 파일은 정적 콘텐츠라 한다.
    - (2) **동적 콘텐츠** : 실행 파일을 돌리고 그 출력을 클라이언트에게 보낸다. 실행파일이 런타임에 만든 출력을 동적 콘텐츠라 한다.
- 웹 서버가 리턴하는 모든 내용들은 서버가 관리하는 파일에 연관된다.
    - 이 파일은 각각 URL라고 하는 고유한 이름을 가진다.
    - 정적 콘텐츠 : `http://www.google.com:80/index.html`
        -  포트 80에서 듣고 있는 웹 서버가 관리하는 /index.html이라는 HTML 파일을 지정한다.
    - 동적 콘텐츠 : `http://bluefish.ics.cs.cmu.edu:8000/cgi-bin/adder?15000&213`
        - 실행파일을 위한 URL은 파일 이름 뒤에 프로그램의 인자를 포함할 수 있다.
        - `/cgi-bin/adder` 라는 실행 파일을 식별하고, 이 파일은 `15000`과 `213`라는 두 가지의 인자와 함께 호출된다.


- 서버의서 접미어를 해석하는 방법
    - 정적/동적 컨텐츠를 참조하는지 결정하기 위한 표준 규칙은 없다. 각각의 서버는 자신이 관리하는 파일들을 위한 자신만의 규칙들을 가진다.
    - 접미어 앞 부분 `/`는 리눅스의 루트 디렉토리가 아닌 어떤 종류의 컨텐츠가 요청되어도 홈 디렉토리를 나타낸다. 
    - 최소한의 URL은 `/` 문자이며, 모든 서버는 `index.html` 같은 특정 기본 홈페이지로 확장한다. 

## 3. HTTP 요청과 응답
### (1) HTTP 요청
HTTP 요청은 **요청 라인**과 따라 나오는 여러 개의 **요청 헤더**, 헤더 리스트들을 종료하는 빈 텍스트 줄이 따라온다.

#### **요청 라인**
요청 라인은 다음과 같은 형태를 갖는다.

`method URI version`
- `method` 
    - `GET`, `POST`, `OPTIONS`, `HEAD`, `PUT`, `DELETE` 등이 포함되어 있다.
    - **GET** 메소드는 서버에서 `URI`에 의해 식별되는 내용을 리턴한다.
- `URI`
    - 해당 URL의 접미어이며, 파일 이름과 선택적 인자들을 포함한다.
- `version`
    - 요청이 준수하는 HTTP 버전을 나타낸다. 
    - **HTTP/1.1:** 캐싱과 보안, 클라이언트와 서버가 동일한 지속적인 연결 위에 다중 트랜잭션을 수행할 수 있도록 매커니즘 등을 제공한다.
    - HTTP/1.0 과 HTTP/1.1은 호환이 가능하며, 1.0 버전은 1.1 헤더를 무시한다.

#### **요청 헤더**
요청 헤더는 브라우저의 이름이나 브라우저가 이해하는 MIME 타입 같은 추가정보를 제공한다.
`header-name : header-data`
    - `Host` 헤더:
        - 브라우저와 요청된 파일을 관리하는 본래의 서버 사이에 중간자 역할을 한다.
        - 하나의 서버에 여러 웹 사이트가 호스팅되어 있을 때, Host 헤더로 같은 IP에서 어떤 웹 사이트를 요청하는지 알 수 있다.

#### **빈 줄**
- 헤더를 종료하고, 서버에게 요청한 HTML 파일을 보낼 것을 명령한다.


### (2) HTTP 응답
HTTP 응답은 **응답 라인**과 따라 나오는 여러 개의 **응답 헤더**, 헤더 리스트들을 종료하는 빈 텍스트 줄, 마지막으로 **응답 바디**가 따라온다.

#### **응답 라인**
응답 라인은 다음과 같은 형태를 갖는다.

`version status-code status-message`
- `version`
    - 응답이 준수해야 할 HTTP 버전을 설명한다.

- `status-code`
    - 3비트 양수로, 요청의 특성을 나타낸다.

- `status-message`
    - 에러 코드를 영어로 나타낸 것이다.

#### **응답 헤더**
응답 헤더는 응답에 대한 추가적인 정보를 제공한다.

- `Content-Type` : 클라이언트에게 응답 바디 내의 컨텐츠의 MIME 타입을 제공한다.
- `Content-Length` : 컨텐츠의 크기를 바이트로 나타낸 것이다.

#### **빈 줄과 응답 바디**
응답 헤더를 종료하는 비어 있는 텍스트 라인은 응답 바디가 따라오며, 이것은 요청한 컨텐츠를 포함한다.

## 4. 동적 컨텐츠의 처리
### (1) 동적 컨텐츠 제공을 위한 질문들
- 어떻게 클라이언트가 프로그램의 인자를 서버에 어떻게 전달하는가?
- 서버는 이 인자들을 자식 프로세스에 어떻게 전달하는가?
- 어떻게 서버는 다른 정보를 자식 프로세스들에게 넘겨주는가?
- 자식은 자신의 출력을 어디로 내보는가?

> 이러한 질문들은 CGI라고 부르는 사실상 표준에 의해 해결된다.
>

### (2) 질문에 대한 해답
#### 어떻게 클라이언트가 프로그램의 인자를 서버에 어떻게 전달하는가?
- GET 요청을 위한 인자들은 URI에서 전달된다.
- 살펴본 바와 같이 `?` 문자는 파일 이름과 인자를 구분한다.
- 각 인자는 `&`로 구분된다.
- 인자들 사이에서는 빈칸은 허용되지 않는다.(`%20` 스트링으로 표시해야 한다.)

#### 어떻게 서버는 인자들을 자식으로 전달하는가?
`GET /cgi-bin/adder?15000&213 HTTP/1.1`

- 서버가 다음과 같은 요청을 받는다.
- 이 때 서버는 `fork`를 호출하여 자식 프로세스를 생성한다.
- `adder`와 같이 CGI 표준의 규칙을 준수하는 프로그램을 **CGI 프로그램**이라 한다.
- `execve()`를 호출하기 전에, 자식 프로세스는 CGI 환경변수 `QUERY_STRING`을 
"15000&213"으로 설정한다.
- `adder` 프로그램은 런타임에 리눅스 getenv 함수를 사용해 이 값을 참조할 수 있다.

#### 어떻게 서버가 자식에게 다른 정보를 넘겨주는가?
- CGI는 CGI 프로그램이 실행될 때 설정되어 있어야 하는 다른 환경변수들의 개수를 정의한다.

#### 자식은 자신의 출력을 어디로 내보는가?
CGI 프로그램은 자신의 동적 컨텐츠를 표준 출력으로 보낸다.

- 자식 프로세스가 CGI 프로그램을 로드하고 실행하기 전에, 리눅스 `dup2`함수를 사용한다.
- `dup2`를 이용해, 자식 프로세스의 표준 출력(1번)을 클라이언트와 연계된 연결 식별자로 재지정한다.
- 결과적으로 CGI 프로그램이 표준 출력이 쓰는 모든 것은 클라이언트로 가게 된다.

> 부모가 자식이 생성한 컨텐츠의 종류와 크기를 알지 못하기 때문에 자식은 `Content-type`과 `Context-Length` 응답 헤더와 헤더를 종료하는 빈줄까지 생성할 책임이 있다.